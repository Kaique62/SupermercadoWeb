<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Hist√≥rico com Tabs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      padding-top: 60px;
    }

    /* NAVBAR ESTILIZADA */
    .navbar {
      background: linear-gradient(to left, #ff6f00, #ffa040);
    }

    /* CONTAINER PRINCIPAL (MAIS COMPACTO) */
    .container-principal {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      padding: 20px;
      max-width: 1300px; /* LARGURA CONTROLADA */
      margin: 0 auto; /* CENTRALIZADO */
      height: 500px;
    }

    /* ABAS ESTILIZADAS */
    .nav-tabs {
      border-bottom: 2px solid #dee2e6;
    }
    .nav-tabs .nav-link {
      font-weight: 600;
      color: #495057;
      border: none;
    }
    .nav-tabs .nav-link.active {
      color: #ff6f00;
      border-bottom: 3px solid #ff6f00;
    }

    /* ACCORDION COMPACTO */
    .accordion-item {
      border: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 8px;
      border-radius: 8px !important;
    }
    .accordion-button {
      padding: 12px 15px;
      font-weight: 600;
    }
    .accordion-button:not(.collapsed) {
      background-color: rgba(255, 111, 0, 0.05);
      color: #ff6f00;
    }

    /* ESTILOS DOS DADOS */
    .linha {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .antes {
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 6px;
      flex: 1;
    }
    .depois {
      background-color: #d4edda;
      padding: 10px;
      border-radius: 6px;
      flex: 1;
    }
    .alteracao-comparacao {
      display: flex;
      gap: 10px;
    }
    .titulo-painel {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    /* SCROLL NAS √ÅREAS DE DADOS */
    .scrollable-content {
    max-height: 400px; /* Ajuste conforme preferir */
    overflow-y: auto;
    padding-right: 10px; /* Evita que o conte√∫do encoste na barra */
    }
    .accordion {
  max-height: 350px;   /* voc√™ pode ajustar esse valor como quiser */
  overflow-y: auto;
  padding-right: 5px; /* para evitar que a barra de rolagem sobreponha conte√∫do */
}
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-light fixed-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="bi bi-box-seam me-2"></i>Hist√≥rico de Produtos
      </span>
    </div>
  </nav>
<!-- Container Principal -->
<div class="container my-4 p-4 bg-white rounded shadow-sm">

    <!-- T√≠tulo -->
    <div class="row mb-3">
      <div class="col-12">
        <h4 class="text-primary"><strong>üì¶ Hist√≥rico de Produtos</strong></h4>
      </div>
    </div>
  
    <!-- Linha de Pesquisa e Exclus√£o -->
    <div class="row g-3 align-items-end">
      
      <!-- Campo de Pesquisa -->
      <div class="col-md-6">
        <label for="pesquisa" class="form-label">Pesquisar produto (nome ou c√≥digo)</label>
        <div class="input-group">
          <input type="text" class="form-control" id="pesquisa" placeholder="Ex: Arroz, 0012..." oninput="carregarHistorico()">
          <button class="input-group-text">üîç</button>
        </div>
      </div>
  
      <!-- Filtro por Categoria -->
      <div class="col-md-3">
        <label for="filtro-categoria" class="form-label">Categoria</label>
        <select class="form-select" id="filtro-categoria" onchange="carregarHistorico()">
            <option value="">Todas</option>
            <option value="entrada">Entrada</option>
            <option value="saida">Sa√≠da</option>
            <option value="alteracao">Altera√ß√µes</option>
        </select>
      </div>
  
      <!-- Excluir -->
      <div class="col-md-3">
        <label for="campo-excluir" class="form-label">Apagar produto ou categoria</label>
        <div class="input-group">
          <input type="text" class="form-control" id="campo-excluir" placeholder="Ex: arroz ou entrada">
          <button class="btn btn-danger" onclick="confirmarExclusao()">üóëÔ∏è Apagar</button>
        </div>
      </div>
    </div>
  
    <!-- Resultados -->
    <div class="mt-4" id="resultado-pesquisa">
      <!-- Resultados da pesquisa ser√£o renderizados aqui -->
    </div>
  
  </div>
  <!-- CONTAINER DE INFORMA√á√ïES -->
  <div style="width: 1300px;" class="mx-auto d-flex justify-content-between align-items-center mb-3 p-3 rounded bg-primary text-white">
    <h4 class="mb-0"><i class="bi bi-archive"></i> Hist√≥rico</h4>
    <button class="btn btn-light fs-4" id="btn-recarrega-estoque" title="Recarregar Estoque"
        onclick="reloadPage()">
        <i class="bi bi-arrow-clockwise"></i>
    </button>
</div>
  <!-- CONTAINER PRINCIPAL (MAIS COMPACTO) -->
  <div class="container-principal mt-4">
    <!-- ABAS -->
    <ul class="nav nav-tabs" id="historicoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="entradas-tab" data-bs-toggle="tab" data-bs-target="#entradas" type="button" role="tab">
          <i class="bi bi-box-arrow-in-down me-1"></i>Entradas
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="saidas-tab" data-bs-toggle="tab" data-bs-target="#saidas" type="button" role="tab">
          <i class="bi bi-box-arrow-right me-1"></i>Sa√≠das
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="alteracoes-tab" data-bs-toggle="tab" data-bs-target="#alteracoes" type="button" role="tab">
          <i class="bi bi-pencil-square me-1"></i>Altera√ß√µes
        </button>
      </li>
    </ul>

    <!-- CONTE√öDO DAS ABAS -->
    <div class="tab-content p-3" id="historicoTabsContent">
      <!-- ABA DE ENTRADAS -->
      <div class="tab-pane fade show active" id="entradas" role="tabpanel">
        <div class="titulo-painel text-success">Entradas Registradas</div>
        <div class="accordion scrollable-content" id="entradasAccordion"></div>
      </div>

      <!-- ABA DE SA√çDAS -->
      <div class="tab-pane fade" id="saidas" role="tabpanel">
        <div class="titulo-painel text-danger">Sa√≠das Registradas</div>
        <div class="accordion scrollable-content" id="saidasAccordion"></div>
      </div>

      <!-- ABA DE ALTERA√á√ïES -->
      <div class="tab-pane fade" id="alteracoes" role="tabpanel">
        <div class="titulo-painel text-primary">Altera√ß√µes Registradas</div>
        <div class="accordion scrollable-content" id="alteracoesAccordion"></div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", carregarHistorico);

async function carregarHistorico() {
    const entradasEl = document.getElementById("entradasAccordion");
    const saidasEl = document.getElementById("saidasAccordion");
    const alteracoesEl = document.getElementById("alteracoesAccordion");

    // Estado de carregamento
    entradasEl.innerHTML = `
        <div class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="text-muted mt-2">Carregando hist√≥rico...</p>
        </div>
    `;
    saidasEl.innerHTML = '';
    alteracoesEl.innerHTML = '';

    try {
        const marketId = localStorage.getItem("marketId") || "1";
        const busca = document.getElementById("pesquisa")?.value || "";
        const categoria = document.getElementById("filtro-categoria")?.value || "";

        // Debug: mostra os par√¢metros enviados
        console.log("Enviando requisi√ß√£o com:", { marketId, busca, categoria });

        const response = await fetch("/historicoData", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ 
                marketId, 
                busca: busca.trim(),
                categoria 
            })
        });

        // Debug: mostra a resposta bruta
        console.log("Resposta recebida:", response);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro ${response.status}: ${errorText}`);
        }

        const result = await response.json();

        // Debug: mostra o resultado parseado
        console.log("Dados recebidos:", result);

        if (!result.success) {
            throw new Error(result.error || "Resposta inv√°lida do servidor");
        }

        // Limpa os containers
        entradasEl.innerHTML = '';
        saidasEl.innerHTML = '';
        alteracoesEl.innerHTML = '';

        if (!result.data || result.data.length === 0) {
            const emptyMsg = `
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    Nenhum registro encontrado com os filtros atuais
                </div>
            `;
            entradasEl.innerHTML = emptyMsg;
            return;
        }

        // Processa os dados
        const grouped = { entrada: [], saida: [], edicao: [] };
        
        result.data.forEach(item => {
            try {
                if (item.type === 'entrada') grouped.entrada.push(item);
                else if (item.type === 'saida') grouped.saida.push(item);
                else if (item.type === 'edicao') grouped.edicao.push(item);
            } catch (e) {
                console.error('Erro ao processar item:', item, e);
            }
        });

        // Renderiza√ß√£o
        renderHistoricoItems(grouped.entrada, entradasEl, 'entrada');
        renderHistoricoItems(grouped.saida, saidasEl, 'saida');
        renderHistoricoItems(grouped.edicao, alteracoesEl, 'edicao');

    } catch (err) {
        console.error("Erro detalhado:", err);
        
        const errorHTML = `
            <div class="alert alert-danger mt-3">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar hist√≥rico</strong>
                <p class="mb-0">${err.message}</p>
                ${process.env.NODE_ENV === 'development' ? 
                    `<pre class="mt-2 small">${err.stack}</pre>` : ''}
            </div>
        `;
        
        entradasEl.innerHTML = errorHTML;
    }
}

function renderHistoricoItems(items, container, type) {
    if (!container || !items) return;

    // Mensagem se n√£o houver itens
    if (items.length === 0) {
        container.innerHTML = `
            <p class="text-muted py-3">
                <i class="bi bi-database-exclamation"></i>
                Nenhum registro de ${getTypeName(type)} encontrado
            </p>
        `;
        return;
    }

    // Limpa o container antes de renderizar
    container.innerHTML = '';

    items.forEach((item, index) => {
        // Garante que beforeData e afterData s√£o objetos v√°lidos
        const before = item.beforeData || {};
        const after = item.afterData || {};
        const dataFormatada = formatDate(item.date);

        // Gera o HTML para cada item
        const itemHTML = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-${type}-${index}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse-${type}-${index}">
                        <i class="bi ${getTypeIcon(type)} me-2 text-${getTypeColor(type)}"></i>
                        ${item.name || `Produto #${item.productId}`}
                        <span class="badge bg-${getTypeColor(type)} ms-2">${dataFormatada}</span>
                    </button>
                </h2>
                <div id="collapse-${type}-${index}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        ${getTypeDetails(type, before, after)}
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', itemHTML);
    });
}

// Fun√ß√µes auxiliares
function getTypeName(type) {
  return {
    entrada: 'entrada',
    saida: 'sa√≠da',
    edicao: 'altera√ß√£o'
  }[type];
}

function getTypeIcon(type) {
  return {
    entrada: 'bi-box-arrow-in-down',
    saida: 'bi-box-arrow-right',
    edicao: 'bi-pencil-square'
  }[type];
}

function getTypeColor(type) {
  return {
    entrada: 'success',
    saida: 'danger',
    edicao: 'primary'
  }[type];
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
}

function getTypeDetails(type, before, after) {
  if (type === 'entrada') {
    return `
      <div class="linha"><strong>Quantidade:</strong> ${after?.stock ?? "-"}</div>
      <div class="linha"><strong>Pre√ßo:</strong> R$ ${(after?.price ?? 0).toFixed(2)}</div>
    `;
  } else if (type === 'saida') {
    return `
      <div class="linha"><strong>De:</strong> ${before?.stock ?? "-"}</div>
      <div class="linha"><strong>Para:</strong> ${after?.stock ?? "-"}</div>
    `;
  } else { // edicao
    return `
      <div class="alteracao-comparacao">
        <div class="antes">
          <h6><strong>Antes:</strong></h6>
          <div class="linha"><strong>Quantidade:</strong> ${before?.stock ?? "-"}</div>
          <div class="linha"><strong>Pre√ßo:</strong> R$ ${(before?.price ?? 0).toFixed(2)}</div>
          ${before?.name ? `<div class="linha"><strong>Nome:</strong> ${before.name}</div>` : ''}
        </div>
        <div class="depois">
          <h6><strong>Depois:</strong></h6>
          <div class="linha"><strong>Quantidade:</strong> ${after?.stock ?? "-"}</div>
          <div class="linha"><strong>Pre√ßo:</strong> R$ ${(after?.price ?? 0).toFixed(2)}</div>
          ${after?.name ? `<div class="linha"><strong>Nome:</strong> ${after.name}</div>` : ''}
        </div>
      </div>
    `;
  }
}

function reloadPage() {
  carregarHistorico();
}

</script>

</body>

</html>